name: ZAP Scan + PDF + Email

on:
  workflow_dispatch:
  push:

jobs:

  # ===============================
  # 1) Run ZAP Scan (Docker + zap.py)
  # ===============================
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Python deps
        run: |
          pip install python-owasp-zap-v2.4
          pip install reportlab
          pip install pdfkit

      - name: Start ZAP Daemon (Docker)
        run: |
          docker run -u root -d -p 8090:8090 \
            ghcr.io/zaproxy/zaproxy:stable zap.sh \
            -daemon -port 8090 \
            -config api.key=${{ secrets.ZAP_API_KEY }}

      - name: Wait 10 seconds for ZAP to boot
        run: sleep 10

      - name: Run zap.py Scan Script
        env:
          ZAP_API_KEY: ${{ secrets.ZAP_API_KEY }}
        run: |
          python zap.py

      - name: Upload ZAP Raw Reports (HTML & JSON)
        uses: actions/upload-artifact@v4
        with:
          name: zap_raw_reports
          path: |
            zap-report.html
            zap-report.json

  # ===============================
  # 2) Convert Reports â†’ PDF
  # ===============================
  convert_to_pdf:
    runs-on: ubuntu-latest
    needs: zap_scan

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download ZAP Artifacts
        uses: actions/download-artifact@v4
        with:
          name: zap_raw_reports

      - name: Install PDF tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf
          pip install reportlab
          pip install pdfkit

      - name: Run PDF Conversion Script
        env:
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}  # NOT USED YET
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }} # NOT USED YET
          GMAIL_RECIPIENT: ${{ vars.MAIL_TO }}
        run: |
          python zap_convert_pdf_email.py

      - name: Upload PDF Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap_pdf_reports
          path: |
            zap-report-html.pdf
            zap-report-json.pdf

  # ===============================
  # 3) SEND EMAIL
  # ===============================
  email_reports:
    runs-on: ubuntu-latest
    needs: convert_to_pdf

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download PDF Reports
        uses: actions/download-artifact@v4
        with:
          name: zap_pdf_reports

      - name: Install Email Dependencies
        run: pip install reportlab pdfkit

      - name: Email Reports
        env:
          GMAIL_EMAIL: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GMAIL_RECIPIENT: ${{ vars.MAIL_TO }}
        run: |
          python zap_convert_pdf_email.py
